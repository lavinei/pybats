---

title: DLMM


keywords: fastai
sidebar: home_sidebar

summary: "A Dynamic Linear Mixture Model, or DLMM, is the combination of a Bernoulli DGLM and a Normal DLM as described in <a href='https://arxiv.org/pdf/2101.03408.pdf'>Yanchenko, Deng, Li, Cron and West (2021)</a>."
description: "A Dynamic Linear Mixture Model, or DLMM, is the combination of a Bernoulli DGLM and a Normal DLM as described in <a href='https://arxiv.org/pdf/2101.03408.pdf'>Yanchenko, Deng, Li, Cron and West (2021)</a>."
nb_path: "nbs/15_dlmm.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/15_dlmm.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The DLMM is a combination of a Bernoulli DGLM and a Normal DLM and is motivated by and similar to the DCMM <a href="https://arxiv.org/pdf/1805.05232.pdf">Berry and West (2019)</a>. The Bernoulli DGLM models the probability of the observation being zero. Conditional on a non-zero outcome, then the continuous observation follows a Normal distribution. This is useful for modeling continuous-valued time series with some observations that are exactly zero; under a Normal distribution, the probability of any one observation being identically zero is 0. For example, DLMMs can be used to model series of log total spend, where at some time points, the total spend is identically $0.</p>
<p>Formally, a DLMM models observations $y_t$ as:
$$
\quad z_{t} \sim Bern(\pi_{t}) \quad \textrm{and}\quad y_{t} | z_{t}  = 
\begin{cases}
0, &amp; \text{if } z_{t} = 0,\\
x_{t}, \quad x_{t} \sim \mathcal{N}(\mathbf{F}_t'\boldsymbol{\theta}_t, \mathbf{V}_t), &amp; \textrm{if}\ z_{t} = 1.
\end{cases}
$$</p>
<p>$\boldsymbol{\theta}_t$ follows a DLM evolution, involving known regression vectors  $\mathbf{F}_t$.</p>
<p>Latent factors are not currently supported for the DLMM.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="dlmm" class="doc_header"><code>class</code> <code>dlmm</code><a href="https://github.com/lavinei/pybats/tree/master/pybats/dlmm.py#L13" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>dlmm</code>(<strong><code>a0_bern</code></strong>=<em><code>None</code></em>, <strong><code>R0_bern</code></strong>=<em><code>None</code></em>, <strong><code>nregn_bern</code></strong>=<em><code>0</code></em>, <strong><code>ntrend_bern</code></strong>=<em><code>0</code></em>, <strong><code>nhol_bern</code></strong>=<em><code>0</code></em>, <strong><code>seasPeriods_bern</code></strong>=<em><code>[]</code></em>, <strong><code>seasHarmComponents_bern</code></strong>=<em><code>[]</code></em>, <strong><code>deltrend_bern</code></strong>=<em><code>1</code></em>, <strong><code>delregn_bern</code></strong>=<em><code>1</code></em>, <strong><code>delhol_bern</code></strong>=<em><code>1</code></em>, <strong><code>delseas_bern</code></strong>=<em><code>1</code></em>, <strong><code>rho</code></strong>=<em><code>1</code></em>, <strong><code>a0_dlm</code></strong>=<em><code>None</code></em>, <strong><code>R0_dlm</code></strong>=<em><code>None</code></em>, <strong><code>nregn_dlm</code></strong>=<em><code>0</code></em>, <strong><code>ntrend_dlm</code></strong>=<em><code>0</code></em>, <strong><code>nhol_dlm</code></strong>=<em><code>0</code></em>, <strong><code>seasPeriods_dlm</code></strong>=<em><code>[]</code></em>, <strong><code>seasHarmComponents_dlm</code></strong>=<em><code>[]</code></em>, <strong><code>deltrend_dlm</code></strong>=<em><code>1</code></em>, <strong><code>delregn_dlm</code></strong>=<em><code>1</code></em>, <strong><code>delhol_dlm</code></strong>=<em><code>1</code></em>, <strong><code>delseas_dlm</code></strong>=<em><code>1</code></em>, <strong><code>delVar_dlm</code></strong>=<em><code>1</code></em>, <strong><code>interpolate</code></strong>=<em><code>True</code></em>, <strong><code>adapt_discount</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A DLMM can be used in the same way as a DGLM, with the standard methods <a href="/pybats/dlmm.html#dlmm.update"><code>dlmm.update</code></a>, <a href="/pybats/dlmm.html#dlmm.forecast_marginal"><code>dlmm.forecast_marginal</code></a>, and <a href="/pybats/dlmm.html#dlmm.forecast_path"><code>dlmm.forecast_path</code></a>. There are equivalent helper functions as well. A full analysis can be run with <a href="/pybats/analysis.html#analysis_dlmm"><code>analysis_dlmm</code></a>, and <a href="/pybats/define_models.html#define_dlmm"><code>define_dlmm</code></a> helps to initialize a DLMM. These helper functions assume that the same predictors <code>X</code> are used for the Bernoulli DGLM and the Normal DLM.</p>
<p>The only difference from using a standard <a href="/pybats/dglm.html"><code>dglm</code></a> is that outside of <a href="/pybats/analysis.html#analysis_dlmm"><code>analysis_dlmm</code></a>, the update and forecast functions do not automatically recognize whether the DLMM calls a copula for path forecasting. This means that the modeler needs to be more explicit in calling the correct method, such as <a href="/pybats/dlmm.html#dlmm.forecast_path_copula"><code>dlmm.forecast_path_copula</code></a> for path forecasting with a copula. The DLMM does not currently support latent factors.</p>
<p>A quick example of using <a href="/pybats/analysis.html#analysis_dlmm"><code>analysis_dlmm</code></a> to model simulated sales data follows.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pybats.shared</span> <span class="kn">import</span> <span class="n">load_sales_example2</span>
<span class="kn">from</span> <span class="nn">pybats.analysis</span> <span class="kn">import</span> <span class="n">analysis_dlmm</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_sales_example2</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sales</th>
      <th>Price</th>
      <th>Promotion</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2014-06-01</th>
      <td>15.0</td>
      <td>1.11</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2014-06-02</th>
      <td>13.0</td>
      <td>2.19</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2014-06-03</th>
      <td>6.0</td>
      <td>0.23</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2014-06-04</th>
      <td>2.0</td>
      <td>-0.05</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2014-06-05</th>
      <td>6.0</td>
      <td>-0.14</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Sales&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Sales&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Sales&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/isaaclavine/opt/anaconda3/envs/pybats/lib/python3.7/site-packages/pandas/core/series.py:679: RuntimeWarning: divide by zero encountered in log
  result = getattr(ufunc, method)(*inputs, **kwargs)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">prior_length</span> <span class="o">=</span> <span class="mi">25</span>   <span class="c1"># Number of days of data used to set prior</span>
<span class="n">k</span> <span class="o">=</span> <span class="mi">7</span>               <span class="c1"># Forecast horizon</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">0.5</span>           <span class="c1"># Random effect discount factor to increase variance of forecast distribution</span>
<span class="n">forecast_samps</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Number of forecast samples to draw</span>
<span class="n">forecast_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2018-01-01&#39;</span><span class="p">)</span> <span class="c1"># Date to start forecasting</span>
<span class="n">forecast_end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;2018-05-01&#39;</span><span class="p">)</span>   <span class="c1"># Date to stop forecasting</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mod</span><span class="p">,</span> <span class="n">samples</span> <span class="o">=</span> <span class="n">analysis_dlmm</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Sales&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">data</span><span class="p">[[</span><span class="s1">&#39;Price&#39;</span><span class="p">,</span> <span class="s1">&#39;Promotion&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                              <span class="n">prior_length</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">forecast_start</span><span class="p">,</span> <span class="n">forecast_end</span><span class="p">,</span>
                              <span class="n">nsamps</span><span class="o">=</span><span class="n">forecast_samps</span><span class="p">,</span>
                              <span class="n">seasPeriods</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">seasHarmComponents</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span>
                              <span class="n">dates</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                              <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span>
                              <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-8-15186e477bbe&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span>                               dates<span class="ansi-blue-fg">=</span>data<span class="ansi-blue-fg">.</span>index<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span>                               rho<span class="ansi-blue-fg">=</span>rho<span class="ansi-blue-fg">,</span>
<span class="ansi-green-fg">----&gt; 7</span><span class="ansi-red-fg">                               ret = [&#39;model&#39;, &#39;forecast&#39;])
</span>
<span class="ansi-green-fg">~/Homework/84.51/Scripts/pybats/pybats/analysis.py</span> in <span class="ansi-cyan-fg">analysis_dlmm</span><span class="ansi-blue-fg">(Y, X, prior_length, k, forecast_start, forecast_end, nsamps, rho, mean_only, dates, holidays, seasPeriods, seasHarmComponents, ret, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    535</span> <span class="ansi-red-fg">#                           nlf = nlf, rho = rho, nhol = nhol, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    536</span>         mod = define_dlmm(Y, X, prior_length = prior_length, seasPeriods = seasPeriods, seasHarmComponents = seasHarmComponents,
<span class="ansi-green-fg">--&gt; 537</span><span class="ansi-red-fg">                           nlf = nlf, rho = rho, nhol = nhol, **kwargs)
</span><span class="ansi-green-intense-fg ansi-bold">    538</span>     <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    539</span>         mod <span class="ansi-blue-fg">=</span> kwargs<span class="ansi-blue-fg">.</span>get<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#39;model_prior&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/Homework/84.51/Scripts/pybats/pybats/define_models.py</span> in <span class="ansi-cyan-fg">define_dlmm</span><span class="ansi-blue-fg">(Y, X, ntrend, nlf, nhol, rho, seasPeriods, seasHarmComponents, deltrend_bern, delregn_bern, delseas_bern, dellf_bern, delhol_bern, deltrend_dlm, delregn_dlm, delseas_dlm, dellf_dlm, delhol_dlm, a0_bern, R0_bern, a0_dlm, R0_dlm, interpolate, adapt_discount, prior_length, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    445</span> 
<span class="ansi-green-intense-fg ansi-bold">    446</span> 
<span class="ansi-green-fg">--&gt; 447</span><span class="ansi-red-fg">     mod = dlmm(a0_bern = bern_mod.a, R0_bern = bern_mod.R,
</span><span class="ansi-green-intense-fg ansi-bold">    448</span>                nregn_bern <span class="ansi-blue-fg">=</span> bern_mod<span class="ansi-blue-fg">.</span>nregn_exhol<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    449</span>                ntrend_bern <span class="ansi-blue-fg">=</span> bern_mod<span class="ansi-blue-fg">.</span>ntrend<span class="ansi-blue-fg">,</span>

<span class="ansi-red-fg">NameError</span>: name &#39;dlmm&#39; is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Because the DLMM is effectively a container for a Bernoulli DGLM and a Normal DLM, we can access each of them individually. The coefficients in the Bernoulli DGLM affect the probability of a non-zero observation, and the coefficients in the Normal DLM impact the value of any non-zero observations.</p>

</div>
</div>
</div>
</div>
 

